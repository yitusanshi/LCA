<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.renren.modules.cycle.dao.UsageStatisticsDao">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.renren.modules.cycle.entity.UsageStatisticsEntity" id="usageStatisticsMap">
        <result property="id" column="id"/>
        <result property="materialId" column="material_id"/>
        <result property="materialName" column="material_name"/>
        <result property="materialUsage" column="material_usage"/>
        <result property="unit" column="unit"/>
        <result property="desc" column="desc"/>
        <result property="parentId" column="parent_id"/>
        <result property="flag" column="flag"/>
        <result property="createdTime" column="created_time"/>
        <result property="version" column="version"/>
        <result property="userId" column="user_id"/>
        <result property="formId" column="form_id"/>
        <result property="prId" column="pr_id"/>
    </resultMap>
    <update id="updateMaterialById" parameterType="java.util.Map">
        update usage_statistics set material_usage=#{materialUsage},
        created_time=now()
        where id=#{id}
    </update>
    <delete id="deleteMaterial" parameterType="java.util.Map">
        delete from usage_statistics where user_id=#{userId,jdbcType=BIGINT} and
        version=#{version,jdbcType=VARCHAR}
        and flag=#{flag,jdbcType=INTEGER}
        and material_id in
        <foreach collection="materialIds" item="materialId" separator="," open="(" close=")">
            #{materialId,jdbcType=INTEGER}
        </foreach>
        or parent_id in
        <foreach collection="materialIds" item="materialId" separator="," open="(" close=")">
            #{materialId,jdbcType=INTEGER}
        </foreach>


    </delete>

    <select id="getMaterialByBatch" parameterType="java.util.Map" resultMap="usageStatisticsMap">
        SELECT * FROM
        usage_statistics u
        WHERE 1=1
        and u.user_id=#{userId} AND u.version=#{version} AND u.flag=#{flag}
        <if test="formId != null">
            and u.form_id=#{formId}
        </if>
        <if test="parentId != null">
            and u.parent_id=#{parentId}
        </if>
        <if test="prId != null">
            and u.pr_id = #{prId}
        </if>
    </select>
    <select id="getUage" resultType="io.renren.modules.cycle.entity.UsageStatisticsEntity"
            resultMap="usageStatisticsMap">
        SELECT* FROM
        usage_statistics
        WHERE
        1 = 1
        <if test="materialId != null">
            and material_id = #{materialId,jdbcType=INTEGER}
        </if>
        <if test="materialName != null">
            and material_name = #{materialName,jdbcType=VARCHAR}
        </if>
        <if test="parentId != null">
            and parent_id = #{parentId,jdbcType=INTEGER}
        </if>
        <if test="flag != null">
            and flag = #{flag,jdbcType=INTEGER}
        </if>
        <if test="version != null">
            and version = #{version,jdbcType=VARCHAR}
        </if>
        <if test="userId != null">
            and user_id = #{userId,jdbcType=BIGINT}
        </if>
        <if test="formId != 0">
            and form_id = #{formId,jdbcType=INTEGER}
        </if>
        <if test="prId != 0">
            and pr_id = #{prId,jdbcType=INTEGER}
        </if>
    </select>

    <select id="getUsageByParm" parameterType="java.util.Map" resultMap="usageStatisticsMap">
        SELECT * FROM usage_statistics WHERE material_id = #{material_id} AND version = #{version} AND flag = #{flag} and form_id = #{form_id} AND user_id = #{user_id}
    </select>

</mapper>